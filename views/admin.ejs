<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= settings.page_title %> - Admin Dashboard</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script defer src="https://unpkg.com/alpinejs@3.13.5"></script>
    <script src="https://unpkg.com/vanilla-picker@2"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link rel="icon" href="/favicon.png">
    <link rel="stylesheet" href="/styles.css">
    <style>
        :root {
            --background-gradient: <%= theme.backgroundGradient %>;
            --container-gradient: <%= theme.containerGradient %>;
            --text-color: <%= theme.textColor %>;
            --link-color: <%= theme.linkColor %>;
            --link-text-color: <%= theme.linkTextColor %>;
        }
        <%- themeContent.css %>
    </style>
</head>
<body style="background: var(--background-gradient); color: var(--text-color);" class="p-4">
    <div id="theme-background" class="absolute inset-0 w-full h-full z-[-1]"><%- themeContent.html %></div>
    <div id="admin-container" class="container mx-auto max-w-2xl p-6 rounded-lg shadow-md relative z-10" style="background: var(--container-gradient);">
        <h1 class="text-2xl font-bold mb-6" style="color: var(--text-color);">Admin Dashboard</h1>

        <div class="mb-8" 
             x-data="{
                imageSrc: '<%= settings.profile_pic_url %>',
                handleFileChange(event) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.imageSrc = e.target.result;
                    };
                    reader.readAsDataURL(event.target.files[0]);
                }
             }">
            <h2 class="text-xl font-semibold mb-4" style="color: var(--text-color);">Profile Settings</h2>
            <form action="/admin/profile" method="POST" class="flex flex-col space-y-4">
                <div class="flex items-center space-x-4">
                    <label for="username" class="w-1/3">Username:</label>
                    <input type="text" id="username" name="username" value="<%= settings.username %>" class="p-2 border border-gray-300 rounded-md w-2/3">
                </div>
                <div class="flex items-center space-x-4">
                    <label for="page_title" class="w-1/3">Page Title:</label>
                    <input type="text" id="page_title" name="page_title" value="<%= settings.page_title %>" class="p-2 border border-gray-300 rounded-md w-2/3">
                </div>
                <div class="flex items-center space-x-4">
                    <label for="profile_pic_file" class="w-1/3">Profile Picture:</label>
                    <input type="file" id="profile_pic_file" @change="handleFileChange" class="p-2 border border-gray-300 rounded-md w-2/3">
                </div>
                <div class="flex items-center space-x-4">
                    <label class="w-1/3">Preview:</label>
                    <img :src="imageSrc" class="w-24 h-24 rounded-full">
                    <textarea name="profile_pic_url" x-model="imageSrc" class="hidden"></textarea>
                </div>
                <div class="flex items-center space-x-4">
                    <label for="bio" class="w-1/3">Bio:</label>
                    <textarea id="bio" name="bio" class="p-2 border border-gray-300 rounded-md w-2/3"><%= settings.bio %></textarea>
                </div>
                <button type="submit" class="bg-green-500 text-white p-2 rounded-md hover:opacity-75 cursor-pointer">Save Profile</button>
            </form>
        </div>

        <div class="mb-8">
            <h2 class="text-xl font-semibold mb-4" style="color: var(--text-color);">Icon Links</h2>
            <form action="/admin/icon-links" method="POST" class="flex flex-col space-y-4">
                <div class="flex items-center space-x-4">
                    <label for="icon_url" class="w-1/3">URL:</label>
                    <input type="text" id="icon_url" name="url" placeholder="https://example.com" class="p-2 border border-gray-300 rounded-md w-2/3">
                </div>
                <div class="flex items-center space-x-4">
                    <label for="svg_code" class="w-1/3">SVG Code:</label>
                    <textarea id="svg_code" name="svg_code" placeholder="<svg>...</svg>" class="p-2 border border-gray-300 rounded-md w-2/3"></textarea>
                </div>
                <button type="submit" class="bg-blue-500 text-white p-2 rounded-md hover:opacity-75 cursor-pointer">Add Icon Link</button>
            </form>
            <div class="mt-4">
                <% iconLinks.forEach(iconLink => { %>
                    <div class="flex items-center justify-between bg-gray-50 p-2 rounded-md mb-2">
                        <div class="w-8 h-8"><%- iconLink.svg_code %></div>
                        <a href="<%= iconLink.url %>" target="_blank" class="text-blue-500 hover:underline"><%= iconLink.url %></a>
                        <form action="/admin/icon-links/<%= iconLink.id %>/delete" method="POST">
                            <button type="submit" class="bg-red-500 text-white px-2 py-1 rounded-md text-sm cursor-pointer hover:opacity-75">Delete</button>
                        </form>
                    </div>
                <% }); %>
            </div>
        </div>

        <div class="mb-8">
            <h2 class="text-xl font-semibold mb-4" style="color: var(--text-color);">Theme Settings</h2>
            <form action="/admin/settings" method="POST" class="flex flex-col space-y-4">
                <div class="flex items-center space-x-4">
                    <label for="containerColor" class="w-1/3" style="color: var(--text-color);">Base Color:</label>
                    <div id="containerColorPicker" class="w-8 h-8 border rounded cursor-pointer"></div>
                    <input type="text" id="containerColor" name="containerColor" value="<%= settings.container_color %>" class="p-2 border border-gray-300 rounded-md w-2/3">
                </div>
                <button type="submit" class="bg-green-500 text-white p-2 rounded-md hover:opacity-75 cursor-pointer">Save Settings</button>
            </form>
        </div>

        <div class="mb-8">
            <h2 class="text-xl font-semibold mb-4" style="color: var(--text-color);">Background Themes</h2>
            <form action="/admin/themes/scan" method="POST" class="mb-4">
                <button type="submit" class="bg-blue-500 text-white p-2 rounded-md hover:opacity-75 cursor-pointer">Scan for New Themes</button>
            </form>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <% themes.forEach(theme => { %>
                    <div class="p-4 border rounded-md <%= settings.active_theme === theme ? 'border-green-500' : '' %>">
                        <p class="font-bold"><%= theme %></p>
                        <% if (settings.active_theme !== theme) { %>
                            <form action="/admin/themes/activate" method="POST" class="mt-2">
                                <input type="hidden" name="themeName" value="<%= theme %>">
                                <button type="submit" class="bg-green-500 text-white px-2 py-1 rounded-md text-sm cursor-pointer hover:opacity-75">Activate</button>
                            </form>
                        <% } else { %>
                            <div class="flex items-center space-x-2 mt-2">
                                <p class="text-green-500 text-sm font-bold">Active</p>
                                <form action="/admin/themes/deactivate" method="POST">
                                    <button type="submit" class="bg-red-500 text-white px-2 py-1 rounded-md text-xs cursor-pointer hover:opacity-75">Deactivate</button>
                                </form>
                            </div>
                        <% } %>
                    </div>
                <% }); %>
            </div>
        </div>

        <div class="mb-8">
            <h2 class="text-xl font-semibold mb-4" style="color: var(--text-color);">Add New Link</h2>
            <form hx-post="/admin/links" hx-target="#link-list" hx-swap="outerHTML" class="flex flex-col space-y-4">
                <input type="text" name="title" placeholder="Link Title" class="p-2 border border-gray-300 rounded-md">
                <input type="url" name="url" placeholder="Link URL" class="p-2 border border-gray-300 rounded-md">
                <button type="submit" class="bg-blue-500 text-white p-2 rounded-md hover:opacity-75 cursor-pointer">Add Link</button>
            </form>
        </div>

        <div>
            <h2 class="text-xl font-semibold mb-4" style="color: var(--text-color);">Manage Links</h2>
            <div id="link-list">
                <%- include('partials/link-list', { links: links }) %>
            </div>
        </div>

        <div class="mt-8" x-data="{ open: false, dbContent: '', locked: true }">
            <h2 class="text-xl font-semibold mb-4" style="color: var(--text-color);">Database Import/Export</h2>
            <div class="flex space-x-2">
                <button @click="open = !open" class="bg-gray-500 text-white p-2 rounded-md hover:opacity-75 cursor-pointer">
                    <span x-text="open ? 'Close' : 'Open'"></span> Import/Export
                </button>
            </div>

            <div x-show="open" class="mt-4 p-4 border rounded-md">
                <div class="flex space-x-2 mb-4">
                    <button @click="fetch('/admin/export').then(res => res.text()).then(data => { dbContent = data; locked = true; })" class="bg-blue-500 text-white p-2 rounded-md hover:opacity-75 cursor-pointer">
                        Download DB Content
                    </button>
                    <button @click="locked = !locked" class="bg-yellow-500 text-white p-2 rounded-md hover:opacity-75 cursor-pointer">
                        Unlock to Import
                    </button>
                </div>
                <form action="/admin/import" method="POST">
                    <textarea name="dbContent" x-model="dbContent" 
                              class="w-full h-64 p-2 border rounded-md" 
                              :class="{ 'bg-gray-400': locked, 'bg-white': !locked }"
                              :readonly="locked"></textarea>
                    <button type="submit" class="bg-green-500 text-white p-2 rounded-md hover:opacity-75 cursor-pointer mt-2" :disabled="locked">
                        Load DB Content
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        function initColorPickers() {
            // Container Color Picker
            const containerColorSwatch = document.getElementById('containerColorPicker');
            const containerColorInput = document.getElementById('containerColor');
            if (containerColorSwatch && containerColorInput) {
                containerColorSwatch.style.backgroundColor = containerColorInput.value;

                new Picker({
                    parent: containerColorSwatch,
                    popup: 'right',
                    color: containerColorInput.value,
                    onChange: function(color) {
                        containerColorSwatch.style.backgroundColor = color.hex;
                        containerColorInput.value = color.hex;
                    }
                });
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            initColorPickers();
        });
    </script>
    <script>
        <%- themeContent.js %>
    </script>
</body>
</html>
